---
title: "Confirmatory Hypothesis Testing"
author: "Erin M. Buchanan"
date: "Last Update `r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, size="scriptsize")
def.chunk.hook <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})
```

## Libraries

```{r}
library(dplyr)
library(psych)
library(tidyr)
library(ggplot2)
library(rio)
set.seed(58902)
library(nlme)
library(MuMIn)
library(performance)
library(parameters)
library(ggridges)
```

## Import the Files

```{r import-data, message = F}
langs <- c("cs", "da", "de", "el", "en", 
           "es", "fr", "hu", "it", "ja", 
           "ko", "pl", "pt_combo", "br_pt_combo", 
           "ro", "ru", "sr", "tr", 
           "zh")

langs.length <- c(rep(1000, 10),
                  1034, 
                  rep(1000, 8))

# original data ----
original <- list.files("../05_Data_real/data_processing/output_data/priming_data",
                       pattern = "prime_summary.csv",
                       full.names = TRUE,
                       recursive = TRUE)

original <- original[grepl(paste0(langs, "_prime_summary.csv",
                                        collapse = "|"), original)]
original.data <- bind_rows(lapply(original, import)) %>% 
  mutate(Language = rep(langs, times = langs.length))

# original 2.5 ----
original2 <- list.files("../05_Data_real/data_processing/output_data/priming_data",
                       pattern = "prime_summary_no2.5.csv",
                       full.names = TRUE,
                       recursive = TRUE)

original2 <- original2[grepl(paste0(langs, "_prime_summary_no2.5.csv",
                                        collapse = "|"), original2)]
original2.data <- bind_rows(lapply(original2, import)) %>% 
  mutate(Language = rep(langs, times = langs.length))

# original 3.0 ----
original3 <- list.files("../05_Data_real/data_processing/output_data/priming_data",
                       pattern = "prime_summary_no3.0.csv",
                       full.names = TRUE,
                       recursive = TRUE)

original3 <- original3[grepl(paste0(langs, "_prime_summary_no3.0.csv",
                                        collapse = "|"), original3)]
original3.data <- bind_rows(lapply(original3, import)) %>% 
  mutate(Language = rep(langs, times = langs.length))
```

```{r import-data-answered, message = F}
langs <- c("cs", "da", "de", "el", "en", 
           "es", "fr", "hu", "it", "ja", 
           "ko", "pl", "pt_combo", "br_pt_combo", 
           "ro", "ru", "sr", "tr", 
           "zh")

langs.length <- c(rep(1000, 10),
                  1034, 
                  rep(1000, 8))

# original.answered data ----
original.answered <- list.files("../05_Data_real/data_processing/output_data/priming_data",
                       pattern = "answered_prime_summary.csv",
                       full.names = TRUE,
                       recursive = TRUE)

original.answered <- original.answered[grepl(paste0(langs, "_answered_prime_summary.csv",
                                        collapse = "|"), original.answered)]
original.answered.data <- bind_rows(lapply(original.answered, import)) %>% 
  mutate(Language = rep(langs, times = langs.length))

# original.answered 2.5 ----
original.answered2 <- list.files("../05_Data_real/data_processing/output_data/priming_data",
                       pattern = "answered_prime_summary_no2.5.csv",
                       full.names = TRUE,
                       recursive = TRUE)

original.answered2 <- original.answered2[grepl(paste0(langs, "_answered_prime_summary_no2.5.csv",
                                        collapse = "|"), original.answered2)]
original.answered2.data <- bind_rows(lapply(original.answered2, import)) %>% 
  mutate(Language = rep(langs, times = langs.length))

# original.answered 3.0 ----
original.answered3 <- list.files("../05_Data_real/data_processing/output_data/priming_data",
                       pattern = "answered_prime_summary_no3.0.csv",
                       full.names = TRUE,
                       recursive = TRUE)

original.answered3 <- original.answered3[grepl(paste0(langs, "_answered_prime_summary_no3.0.csv",
                                        collapse = "|"), original.answered3)]
original.answered3.data <- bind_rows(lapply(original.answered3, import)) %>% 
  mutate(Language = rep(langs, times = langs.length))
```
## Hypothesis 1

```{r hyp1-original, message = F}
# run the analysis
hyp1 <- lm(avgZ_prime ~ 1, data = original.data)

# print the results
summary(hyp1)
parameters(hyp1)
model_performance(hyp1)
```

Hypothesis information is presented in Table XX. Hypothesis 1 predicts semantic facilitation with reduced response latencies for related than unrelated words. Hypothesis 1 was analyzed by calculating an intercept-only regression model using the *z*-scored priming response latency as the dependent variable. 



The intercept and its 95% confidence interval will represent the grand mean of the priming effect across all languages. The priming response latency is calculated by taking the average of the unrelated pair z-scored response latency minus the related pair response latency within each item. Therefore, values that are positive and greater than zero (e.g., > 0.0001) indicate priming because the related pair had a faster response latency than the unrelated pair. We will determine support for Hypothesis 1 if the lower limit of the confidence interval is greater than zero (i.e., a directional comparison). This process will be repeated for average priming scores calculated without trials that were marked as 2.50 z-score outliers and 3.00 z-score outliers separately. The decision criteria will remain the same, and we will identify any differences in decisions based on outlier statistics (e.g., priming only occurs when X trials are removed). 

## Hypothesis 2

Hypothesis 2 explores the extent to which these semantic priming effects vary across languages. Therefore, we will calculate a random effects model using the nlme99 package in R wherein the random intercept of language will be added to the overall intercept only model for Hypothesis 1. We will report the standard deviation of the random effect, its 95% confidence interval, the AIC change between models, and the pseudo-R2 values for the effect size of this parameter100. Results will support significant heterogeneity when the AIC for the random effects model is two points or more less than the AIC for the intercept-only model56. This analysis will be repeated with the 2.50 z-score outliers and 3.00 z-score outliers excluded. We will include a forest plot of the priming effect and their 95% confidence intervals to visualize the potential heterogeneity in the priming results. Simulations of models within and without variability in the priming effects can be found at https://osf.io/fbhr8/.

```{r}
# run the model
hyp2 <- lme(avgZ_prime ~ 1, 
            data = original.data, 
            method = "REML", 
            na.action = "na.omit",
            random = ~1|Language)

# model assumptions
performance::check_model(hyp2)

# print the results
summary(hyp2)
parameters(hyp2)
model_performance(hyp2)
intervals(hyp2)

# compare models
AIC(hyp1)
AIC(hyp2)

# effect size
r.squaredGLMM(hyp2)
```

```{r}
# forest plot
combo.original <- bind_rows(
  original.data %>% mutate(cutoff = "None"),
  original2.data %>% mutate(cutoff = "Z = 2.5"),
  original3.data %>% mutate(cutoff = "Z = 3.0")
)

# re org the data
order <- original.data %>% 
  ungroup() %>% 
  group_by(Language) %>% 
  summarize(avgZ_prime = mean(avgZ_prime, na.rm = T)) %>% 
  arrange(avgZ_prime) %>% 
  pull(Language)

combo.original <- combo.original %>% 
  mutate(Language = factor(Language, 
                           levels = order))

ggplot(combo.original, aes(Language, avgZ_prime, color = cutoff)) +
  stat_summary(fun.data = mean_cl_normal, 
               geom = "errorbar", 
               width = .2, 
               position = position_dodge(width = .2)) + 
  stat_summary(fun = mean,
               geom = "point", 
               position = position_dodge()) + 
  xlab("Language") + 
  ylab("Z Score Priming") +
  theme_classic() + 
  geom_hline(yintercept = .1165) + 
  coord_flip() + 
  facet_wrap(~cutoff)
```

```{r message = F}
ggplot(original.data %>% 
  mutate(Language = factor(Language, 
                           levels = order)), 
         aes(avgZ_prime, Language)) + 
  geom_density_ridges(scale = 3, alpha = .5) + 
  theme_bw() + 
  #coord_cartesian(xlim = c(-1,1)) + 
  xlab("Z-Score Priming")
```


```{r}
# forest plot
combo.answered.original <- bind_rows(
  original.answered.data %>% mutate(cutoff = "None"),
  original.answered2.data %>% mutate(cutoff = "Z = 2.5"),
  original.answered3.data %>% mutate(cutoff = "Z = 3.0")
)


ggplot(combo.answered.original, aes(Language, avgZ_prime, color = cutoff)) +
  stat_summary(fun.data = mean_cl_normal, 
               geom = "errorbar", 
               width = .2, 
               position = position_dodge(width = .2)) + 
  stat_summary(fun = mean,
               geom = "point", 
               position = position_dodge()) + 
  xlab("Language") + 
  ylab("Z Score Priming") +
  theme_classic() + 
  coord_flip() + 
  facet_wrap(~cutoff)
```

```{r message = F}
ggplot(combo.answered.original, aes(avgZ_prime, Language, color = cutoff)) + 
  geom_density_ridges(scale = 3) + 
  theme_bw() + 
  coord_cartesian(xlim = c(-1,1)) + 
  facet_wrap(~cutoff)
```
